## 进程（process）,线程（thead）

* 什么是进程：进程是cpu资源分配的最小单位；（是能拥有资源和独立运行的最小单位）
* 什么是线程：线程是cpu调度的最小单位；（线程是建立在进程的基础上的一次程序运行单位）

* 一个进程由一个或多个线程组成
* 进程之间相互独立
* 同一进程下的各个线程之间共享程序的内存空间（包括代码段、数据集、堆等）
* 多个线程在进程中协作完成任务

```
比喻：进程 就是一个公司，每个公司都有自己的资源可以调度；公司之间是相互独立的；而 线程 就是公司中的每个员工，多个员工一起合作，完成任务，公司可以有一名员工或多个，员工之间共享公司的空间。
```


`对于操作系统来说,一个任务就是一个进程`,比如打开一个浏览器就是启动了一个浏览器进程,打开一个 Word 就启动了一个 Word 进程。

有些进程同时不止做一件事,比如 Word,它同时可以进行打字、拼写检查、打印等事情。`在一个进程内部,要同时做多件事,就需要同时运行多个“子任务”,我们把进程内的这些“子任务”称为线程。`


多线程：  
* 多线程在单核cpu中也是按顺序执行，事件交叉进行（并发执行）  
* 多线程在多核cpu就可以同时执行
* 多线程存在的问题
  * 多个线程操作同一事件（锁的问题）
  * 切换线程时会有消耗（通过切换时间片的方式，达到同时执行多个任务）
  * 占用内存（虽然可以通过线程池解决，但依旧占用内存）


单线程：
* 不存在锁的问题，（多个线程操作同一个事件）
* 不存在切换线程时消耗的问题，（线程切换操作多个事件）
* 节省内存


## 浏览器的渲染进程是多线程的
![](/img/process.png)


在浏览器中，每打开一个tab页面，其实就是新开了一个进程。
### 进程
* 主进程 Browser Process
  >负责浏览器界面的显示与交互。各个页面的管理,创建和销毁其他进程。网络的资源管理、下载等。
* 第三方插件进程 Plugin Process
  >每种类型的插件对应一个进程,仅当使用该插件时才创建。
* GPU 进程 GPU Process
  >最多只有一个,用于 3D 绘制等
* 渲染进程 Renderer Process
  >称为浏览器渲染进程或浏览器内核,内部是多线程的。主要负责页面渲染,脚本执行,事件处理等。 (本文重点分析)

### 渲染进程 (浏览器内核)
![](/img/thread.jpg)
* GUI渲染线程  
  > 
      负责渲染浏览器界面，解析HTML，CSS，构建DOM树和RenderObject树，布局和绘制等。  
      当界面需要重绘（Repaint）或由于某种操作引发回流(reflow)时，该线程就会执行  
      注意，`GUI渲染线程与JS引擎线程是互斥的`，当JS引擎执行时GUI线程会被挂起（相当于被冻结了），GUI更新会被保存在一个队列中等到JS引擎空闲时立即被执行。  

* JS引擎线程  
  >
      JS引擎也称为JS内核，负责处理Javascript脚本程序。（例如V8引擎）   
      JS引擎线程负责解析Javascript脚本，运行代码。   
      JS 引擎一直等待着任务队列中任务的到来,然后加以处理,一个 Tab 页（renderer 进程）中无论什么时候都只有一个 JS 线程在运行 JS 程序。  
      同样注意，`GUI渲染线程与JS引擎线程是互斥的`，所以如果JS执行的时间过长，这样就会造成页面的渲染不连贯，导致页面渲染加载阻塞。  

* 事件触发线程  
  >
      事件触发线程归属于浏览器而不是JS引擎，用来控制事件循环（可以理解，JS引擎自己都忙不过来，需要浏览器另开线程协助）  
      当JS引擎执行代码块如setTimeOut时（也可来自浏览器内核的其他线程,如鼠标点击、AJAX异步请求等），会将对应任务添加到事件线程中  
      当对应的事件符合触发条件被触发时，该线程会把事件添加到待处理队列的队尾，等待JS引擎的处理  
      注意，由于JS的单线程关系，所以这些待处理队列中的事件都得排队等待JS引擎处理（当JS引擎空闲时才会去执行）

* 定时触发器线程  
  >
      传说中的 setInternal与 setTimeout所在线程  
      浏览器定时计数器并不是由JavaScript引擎计数的,（因为JavaScript引擎是单线程的, 如果处于阻塞线程状态就会影响记计时的准确）  
      因此通过单独线程来计时并触发定时（计时完毕后，添加到事件队列中，等待JS引擎空闲后执行）  
      注意，W3C在HTML标准中规定，规定要求setTimeout中低于4ms的时间间隔算为4ms。

* 异步http请求线程  
  >
      在XMLHttpRequest在连接后是通过浏览器新开一个线程请求  
      将检测到状态变更时，如果设置有回调函数，异步线程就产生状态变更事件，将这个回调再放入事件队列中。再由JavaScript引擎执行。

## js是单线程的：

JS的单线程指的是javaScript引擎只有一个线程

单线程就意味着，所有任务需要排队，前一个任务结束，才会执行后一个任务。如果前一个任务耗时很长，后一个任务就不得不一直等着。  
js 引擎执行异步代码而不用等待，是因有为有任务队列和事件轮询。
* 任务队列：任务队列是一个先进先出的队列，它里面存放着各种任务回调。
* 事件轮询：事件轮询是指主线程重复从任务队列中取任务、执行任务的过程。

js是作为浏览器的脚本语言，主要是实现用户与浏览器的交互，以及操作dom；这决定了它只能是单线程，否则会带来很复杂的同步问题。 

举个例子：如果js被设计了多线程，如果有一个线程要修改一个dom元素，另一个线程要删除这个dom元素，此时浏览器就会一脸茫然，不知所措。所以，为了避免复杂性，从一诞生，JavaScript就是单线程。


## 多进程优缺点
多进程优点
* 由于默认 新开 一个 tab 页面 新建 一个进程,所以单个 tab 页面崩溃不会影响到整个浏览器。  
* 同样,第三方插件崩溃也不会影响到整个浏览器。  
* 多进程可以充分利用现代 CPU 多核的优势。  
* 方便使用沙盒模型隔离插件等进程,提高浏览器的稳定性  

多进程缺点
* 系统为浏览器新开的进程分配内存、CPU 等资源,所以内存和 CPU 的资源消耗也会更大。
