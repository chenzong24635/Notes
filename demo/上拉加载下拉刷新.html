<!doctype html>
<html lang="en">
<head>
  <meta name="viewport" content="initial-scale=1, user-scalable=0, minimal-ui" charset="UTF-8">
  <title>移动端滑动到底加载</title>
  <!-- UC强制全屏 -->
  <meta name="full-screen" content="yes">
  <!-- QQ强制全屏 -->
  <meta name="x5-fullscreen" content="true">
  <!-- <link type="text/css" rel="stylesheet" href="dist/simplePagination.css"> -->
  <link rel="stylesheet" href="dist/dropload.css">
  
  <style>
    .news-item{
      margin-bottom: 40px ;
      font-size: 14px;
      overflow: hidden;
    }
    .news-item-img,
    .news-item-div{
      width: 50%;
      float: left;
    }
    img{
      width:100%;
    }
    span, a{text-decoration:none;user-select: none;}
    .page{margin:30px auto;width:620px}
  </style>
</head>
<body>
<!-- <div id="paging" class="page light-theme simple-pagination">
</div> -->
<div class="content">
  <ul class="lists"></ul>
</div>
<!-- <div class="content">
  <ul class="lists"></ul>
</div> -->
<!-- jQuery1.7以上 或者 Zepto 二选一，不要同时都引用 -->
<script src="dist/jquery.min.js"></script>
<!-- <script src="dist/zepto.min.js"></script> -->
<script src='dist/cookie.js'></script>
<script src='dist/url.js'></script>
<script src="dist/dropload.js"></script>
<!-- <script type="text/javascript" src="dist/jquery.simplePagination.js"></script> -->
<script>
$(function(){
  var cid = '';
  var lists = [];
  var len = 0;//总个数
  var pageSize = 5;//每页加载个数
  var pageNum = 1;//点击加载的页数

  // dropload
  $('.content').dropload({
    scrollArea : window,
    domUp : {
      domClass   : 'dropload-up',
      domRefresh : '<div class="dropload-refresh">↓下拉刷新</div>',
      domUpdate  : '<div class="dropload-update">↑释放更新</div>',
      domLoad    : '<div class="dropload-load"><span class="loading"></span>加载中</div>'
    },
    domDown : {
      domClass   : 'dropload-down',
      domRefresh : '<div class="dropload-refresh">↑上拉加载更多</div>',
      domLoad    : '<div class="dropload-load"><span class="loading"></span>加载中</div>',
      domNoData  : '<div class="dropload-noData">没有更多了</div>'
    },
    loadUpFn : function(me){//下拉刷新-加载第一页
      pageNum = 1;//
      var json = {
        order:"ASC",
        pageNum:pageNum,
        pageSize:pageSize
      }
      
      var result = '';
      $.ajax({
        url:callurl+'/web/newlist',
        type:'post',
        data:JSON.stringify(json),
        contentType: 'application/json',
        dataType: "json",
        success: function(data){
          console.log(data)
          var arrLen = data.data.list.length;
          if(arrLen > 0){
            var lists = data.data.list;
            console.log(lists)
            for(var i=0; i<arrLen; i++){
              result += ` 
                <li class="news-item clearfix" data-id=${lists[i].cid} data-newitemid=${lists[i].id}>
                  <a class="news-item-img" data-newitemid=${lists[i].id} href="javascript:;">
                      <img src=${lists[i].pic} alt=${lists[i].title} title=${lists[i].title} onerror="this.src='./images/newsList-3.jpg'"/>
                  </a>
                  <div class="news-item-div">
                      <p class="title fs20">${lists[i].title}</p>
                      <p class="date mt10 fs20"></p>
                  </div>
                </li>   
                `
            }
          }else{// 如果没有数据
            me.lock();// 锁定
            me.noData(); // 无数据
          }
          pageNum++;//以便上拉加载时不会重复加载第一页
          $('.lists').html(result);// 插入数据到页面，放到最后面
          me.resetload();// 每次数据插入，必须重置
        },
        error: function(xhr, type){
          me.resetload(); // 即使加载出错，也得重置
        }
      });
    },
    loadDownFn : function(me){//上拉加载
      var json = {
        order:"ASC",
        pageNum:pageNum,
        pageSize:pageSize
      }
      var result = '';
      $.ajax({
        url:callurl+'/web/newlist',
        type:'post',
        data:JSON.stringify(json),
        contentType: 'application/json',
        dataType: "json",
        success: function(data){
          console.log(data)
          var arrLen = data.data.list.length;
          if(arrLen > 0 && pageNum <= data.data.lastPage+1){//判断是否有数据且为最后页
            var lists = data.data.list;
            console.log(lists)
            for(var i=0; i<arrLen; i++){
              result += ` 
                <li class="news-item clearfix" data-id=${lists[i].cid} data-newitemid=${lists[i].id}>
                  <a class="news-item-img" data-newitemid=${lists[i].id} href="javascript:;">
                      <img src=${lists[i].pic} alt=${lists[i].title} title=${lists[i].title} onerror="this.src='./images/newsList-3.jpg'"/>
                  </a>
                  <div class="news-item-div">
                      <p class="title fs20">${lists[i].title}</p>
                      <p class="date mt10 fs20"></p>
                  </div>
                </li>   
                `
            }
          }else{ // 如果没有数据
            me.lock();// 锁定
            me.noData();// 无数据
          }
          pageNum++;
          $('.lists').append(result);// 插入数据到页面，放到最后面
          me.resetload();// 每次数据插入，必须重置
        },
        error: function(xhr, type){
          me.resetload();// 即使加载出错，也得重置
        }
      });
    },
    threshold : 50, //拉动距离
    threshold : 0 //提前加载距离
  });
  
}); 
</script>
</body>
</html>